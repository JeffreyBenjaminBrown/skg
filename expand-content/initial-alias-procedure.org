#+title: Initial Alias View Procedure
#+date: 2025-11-14
* Overview

This document describes how a user requests and receives an alias view for a node in the Skg system. The process involves the Emacs client sending a headline to the Rust server, which responds with org-mode text that is grafted into the buffer at a specific location.

* How the User Requests the Alias View from Emacs

The user invokes the interactive function =skg-request-node-aliases= (defined in =elisp/skg-request-node-aliases.el=). This function:

1. Can be called interactively (e.g., via =M-x skg-request-node-aliases=)
2. Must be invoked when point is on a headline with a skg ID in its metadata

* What is Sent to the Rust Server

** Data Extraction (Client Side)

The client extracts two pieces of information:

1. *Headline text*: Obtained via =skg-get-current-headline-text= (defined in =elisp/skg-metadata.el:141=)
   - Returns the full headline including asterisks, metadata, and title
   - Example: =** (skg (id node-123) (source main)) My Node Title=

2. *Insertion point*: Calculated via =skg-find-branch-insertion-point= (defined in =elisp/skg-request-node-aliases.el:37=)
   - Finds the position after the headline and its body text
   - Returns a marker where aliases should be inserted
   - Searches forward for the next headline or end of buffer

** Request Format

The client sends an s-expression over TCP:

#+begin_src emacs-lisp
((request . "node aliases")
 (headline . "** (skg (id node-123) (source main)) My Node Title"))
#+end_src

Followed by a newline character (=\n=).

* How the Server Computes its Response

** Request Parsing (rust/serve.rs:130)

The main request dispatcher identifies "node aliases" requests and routes them to =handle_node_aliases_request= (defined in =rust/serve/handlers/node_aliases.rs=).

** =parse_headline_from_sexp= => (OrgnodeMetadata, level, title)

The handler calls =parse_headline_from_sexp= (defined in =rust/serve/parse_headline_md_sexp.rs:15=) which:

1. Parses the s-expression request
2. Extracts the =headline= value from the =(headline . ...)= pair
3. Counts the headline level (number of asterisks)
4. Separates metadata from title
5. Returns =(OrgnodeMetadata, level, title)=

** =fetch_aliases_from_file= => Vect<String (alias)>

The server calls =fetch_aliases_from_file= (defined in =rust/media/file_io/one_node.rs:53=) which:

1. Queries TypeDB to get the PID and source for the given ID
   - Uses =pid_and_source_from_id= to resolve ID → (PID, source)
2. Constructs the file path using =path_from_pid_and_source=
   - Format: =<source_path>/<pid>.skg=
3. Reads the node file using =read_node=
4. Extracts the =aliases= field from the SkgNode
5. Returns =Vec<String>= (empty vector if no file or no aliases)

** =aliases_to_org= => org text of the alias subtree

The server calls =aliases_to_org= (defined in =rust/mk_org_text/aliases.rs:17=) which:

1. Creates an AliasCol child node:
   - Level: =parent_level + 1=
   - Metadata: =(skg (code (relToParent aliasCol)))=
   - Title: empty string
   - Body: None

2. For each alias string, creates an Alias grandchild:
   - Level: =parent_level + 2=
   - Metadata: =(skg (code (relToParent alias)))=
   - Title: the alias string
   - Body: None

3. Renders each node using =render_org_node_from_text=
4. Returns concatenated org-mode text

Example output for a node with aliases "foo" and "bar":
#+begin_example
*** (skg (code (relToParent aliasCol)))
**** (skg (code (relToParent alias))) foo
**** (skg (code (relToParent alias))) bar
#+end_example

** Sending the Response

The server calls =send_response_with_length_prefix= (defined in =rust/serve/util.rs:16=) which:

1. Formats the response with HTTP-style headers:
   #+begin_example
   Content-Length: <bytes>\r\n\r\n<payload>
   #+end_example
2. Writes the header and payload to the TCP stream
3. Flushes the stream

* Does the Server Send Back a Full Content View or Just a Portion?

** Server Response: Portion Only

The server sends back *only a portion of text* - specifically, the AliasCol child node and its Alias grandchildren as org-mode text.

The server does *not*:
- Send the full buffer
- Include the original headline
- Include any pre-existing children
- Include any context beyond the alias subtree

** Rationale

From the comment in =rust/mk_org_text/aliases.rs:5-16=:

#+begin_quote
Returns not an entire org buffer,
but rather just a passage,
which should replace the current headline and its body.
The new passage includes the current headline
with potentially different metadata (if it is part of a cycle),
the same body, a child 'aliases' headline,
and a grandchild under it corresponding to each alias.
If there are no aliases, the child will still be included --
that's how a user can add aliases when there are none.
Neither child nor grandchildren will include bodies.
Prior children are retained
(not that this function knows about them).
#+end_quote

Note: The comment mentions "replace the current headline" but the actual implementation only returns the AliasCol child and its Alias grandchildren. The headline and body are not included in the response.

* How the Text is Grafted In by the Client

The client-side grafting is handled by =skg-insert-aliases-at-point= (defined in =elisp/skg-request-node-aliases.el:50=):

#+begin_src emacs-lisp
(defun skg-insert-aliases-at-point
    (insertion-marker payload)
  "Insert PAYLOAD at INSERTION-MARKER position."
  (save-excursion
    (goto-char insertion-marker)
    (unless (bolp) (insert "\n"))
    (insert payload)
    (unless (string-suffix-p "\n" payload) (insert "\n"))))
#+end_src

** Insertion Process

1. *Navigate*: Jump to the insertion marker (after headline and body)
2. *Ensure newline*: If not at beginning of line, insert a newline
3. *Insert payload*: Insert the org-mode text received from server
4. *Ensure trailing newline*: If payload doesn't end with newline, add one
5. *Restore position*: =save-excursion= returns point to original location

** Result

The aliases appear as children of the current headline:
#+begin_example
** (skg (id node-123) (source main)) My Node Title
Body text of the node...
*** (skg (code (relToParent aliasCol)))
**** (skg (code (relToParent alias))) foo
**** (skg (code (relToParent alias))) bar
*** (skg (code (relToParent content))) Pre-existing Child
#+end_example

** Important Characteristics

- *Additive operation*: The insertion adds new content; it doesn't replace anything
- *No validation*: The client doesn't verify the response structure
- *Idempotent-ish*: Calling again will add another AliasCol child (duplicates possible)
- *Position-dependent*: Insertion happens at a specific point, preserving existing children

* Summary Flow Diagram

#+begin_example
User (M-x skg-request-node-aliases)
  ↓
Client: Extract headline text and compute insertion point
  ↓
Client: Send s-expression: ((request . "node aliases") (headline . "..."))
  ↓
Server: Parse s-expression → extract ID and level
  ↓
Server: Query TypeDB (ID → PID + source)
  ↓
Server: Read <source>/<pid>.skg from filesystem
  ↓
Server: Extract aliases field
  ↓
Server: Format as org-mode (AliasCol + Alias children)
  ↓
Server: Send with length prefix: "Content-Length: N\r\n\r\n<org-text>"
  ↓
Client: Receive length-prefixed payload
  ↓
Client: Insert payload at computed insertion point
  ↓
Result: Buffer now has AliasCol child with Alias grandchildren
#+end_example

* Related Files

** Emacs Client
- =elisp/skg-request-node-aliases.el= - Main entry point
- =elisp/skg-metadata.el= - Headline text extraction
- =elisp/skg-length-prefix.el= - Length-prefixed protocol handling

** Rust Server
- =rust/serve.rs= - Request routing
- =rust/serve/handlers/node_aliases.rs= - Request handler
- =rust/serve/parse_headline_md_sexp.rs= - Headline parsing
- =rust/media/file_io/one_node.rs= - File reading and alias extraction
- =rust/mk_org_text/aliases.rs= - Org-mode formatting
- =rust/serve/util.rs= - Response sending
