#+title: Temporary Changes During Multi-Source Implementation
#+date: 2025-11-11

* Purpose

This document tracks temporary workarounds added during Phase 1 to get the code compiling after removing =skg_folder=. These changes will be properly implemented in later phases.

* Resolved

** rust/init.rs (Lines 30-37)

*** What was changed
File loading was hardcoded to only read from the "main" source.

*** Temporary implementation (now removed)
#+begin_src rust
// TODO Phase 3: Replace with read_all_skg_files_from_sources
// For now, temporarily read from "main" source to get Phase 1 compiling
let main_source : &SkgfileSource =
  config . sources . get ( "main" )
  . expect ( "Config must have a 'main' source" );
let skg_folder_str: &str =
  main_source . path
  . to_str () . expect ("Invalid UTF-8 in skg folder path");
#+end_src

*** Resolution (Phase 3)
Replaced with proper multi-source loading:
- Implemented =read_all_skg_files_from_sources= in =rust/media/file_io/multiple_nodes.rs=
- Updated =initialize_dbs= to call the new function
- Function iterates over all sources and sets source field correctly
- Added duplicate ID detection across sources

*** Status
✓ Resolved in Phase 3

* Resolved (Phase 5 Completion - 2025-11-11)

** rust/util.rs (Lines 13-28)

*** What was changed
=path_from_pid_and_source= function signature updated to accept source parameter.

*** Previous signature
#+begin_src rust
pub fn path_from_pid_and_source (
  config : &SkgConfig,
  pid    : ID,
) -> String
#+end_src

*** New signature (Phase 5)
#+begin_src rust
pub fn path_from_pid_and_source (
  config : &SkgConfig,
  source : &str,
  pid    : ID,
) -> String
#+end_src

*** Resolution
All call sites updated to pass source parameter:
- Category A sites (3): pass node.source directly
- Category B sites (8): use =pid_and_source_from_id= to query TypeDB
- Category C site (1): use reconciled_source_value

*** Status
✓ Fully resolved in Phase 5 - All temporary workarounds removed

** rust/media/file_io/multiple_nodes.rs

*** What was changed
=write_all_nodes_to_fs= and =delete_all_nodes_from_fs= now use node.source field.

*** Resolution (Phase 5)
Functions iterate over nodes and use each node's source field to construct paths via =path_from_pid_and_source(config, &node.source, pid)=.

*** Status
✓ Resolved in Phase 5

** rust/save.rs

*** What was changed
Print message made generic instead of showing target directories.

*** Resolution (Phase 5)
Generic message kept for now. Could be enhanced in future to show per-source write counts, but current implementation is sufficient.

*** Status
✓ Resolved in Phase 5 - Acceptable as-is

** All file reading locations (10 locations)

*** What was changed
All locations that read nodes from disk needed to set source field after reading.

*** Temporary implementation (Phase 1-4)
All set =node.source = "main".to_string()= with TODO Phase 5 comments.

*** Resolution (Phase 5)
All locations now properly determine source:
- rust/media/file_io/one_node.rs: Uses =pid_and_source_from_id= (2 functions became async)
- rust/merge/mergeInstructionTriple.rs: Uses =pid_and_source_from_id=
- rust/save/orgnodes_to_instructions/none_node_fields_are_noops.rs: Uses =pid_and_source_from_id=
- rust/rebuild/complete_aliascol.rs: Uses =pid_and_source_from_id=
- rust/rebuild/complete_contents.rs: Uses =pid_and_source_from_id=
- rust/mk_org_text/content_view.rs: Uses =pid_and_source_from_id= (3 locations)
- rust/media/file_io/multiple_nodes.rs: Determines source from directory being read

*** Status
✓ All resolved in Phase 5

** TypeDB Integration

*** What was needed
TypeDB must store source attribute for =pid_and_source_from_id= queries to work.

*** Resolution (Early Phase 10 completion)
Updated =create_node= in rust/media/typedb/nodes.rs:134-140 to include source:
#+begin_src rust
let insert_node_query : String = format! (
  r#"insert $n isa node,
               has id "{}",
               has source "{}";"#,
  primary_id,
  node . source );
#+end_src

*** Status
✓ Resolved - TypeDB portion of Phase 10 completed early

** Test Infrastructure

*** What was needed
Tests needed updating for async function signatures and source consistency.

*** Resolution (Phase 5)
1. Updated test files to use async/await pattern:
   - tests/save/none_node_fields_are_noops.rs (4 tests)
   - tests/rebuild/complete_contents.rs (helper + all call sites)
2. Fixed source nickname mismatch in rust/test_utils.rs:
   - Changed =populate_test_db_from_fixtures= to use "main" (was "test")
   - Now consistent with config created by =setup_test_tantivy_and_typedb_dbs=

*** Status
✓ All resolved - 122 tests passing

* Summary

All temporary workarounds resolved in Phase 5 (completed 2025-11-11).

Key changes:
- =path_from_pid_and_source= signature updated with source parameter
- All file reading locations now determine source via TypeDB queries
- TypeDB stores and queries source attribute
- Test infrastructure updated for async patterns
- All 122 tests passing

No TODO Phase 5 comments remain in codebase.
