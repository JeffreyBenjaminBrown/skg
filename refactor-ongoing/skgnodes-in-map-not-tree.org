#+title: Refactoring: SkgNodes in Map, not Tree

* Motivation

Why keep a map instead of looking up each SkgNode as needed? This avoids redundant disk lookups during completion and view-expansion phases. The SkgNode is built early (from SaveInstructions or fetched once) and reused.

* Target Architecture

- =Tree<OrgNode>=: Stores tree structure and OrgNode data
- =HashMap<ID, SkgNode>=: Stores SkgNode data, accessed by ID
- Type alias: =SkgNodeMap = HashMap<ID, SkgNode>=

Key patterns:
- Get node ID from tree, look up SkgNode in map
- When adding nodes: update BOTH tree and map together
- Many operations only need OrgNode data (rendering, metadata)

* Refactoring Strategy

Create v2 versions of functions alongside old versions. Use incremental approach with temporary conversions when needed. Each chunk keeps tests passing.

* Progress

** DONE Chunk 1: Create Type Alias and Helper Functions

Created in =server/types/skgnode.rs=:
- =SkgNodeMap= type alias
- =skgnode_for_orgnode= - lookup by OrgNode ID
- =skgnode_map_from_save_instructions= - build map from save instructions

** DONE Chunk 2: Conversion Helpers

Created in =server/types/tree/orgnode_skgnode.rs=:
- =tree_and_map_from_pairtree= - converts PairTree to Tree<OrgNode> + map
- =pairtree_from_tree_and_map= - converts back (for compatibility)
- Round-trip conversion tested and working

** DONE Chunk 3: Generic Map Helper

Created in =server/types/maps.rs=:
- =add_v_to_map_if_absent= - async fetch-if-missing for map
- Generic over key/value types and async closures

** DONE Chunk 4: Tree Helper Functions

Created =_in_orgtree= versions of tree utilities in =server/to_org/util.rs=:
- =detect_and_mark_cycle_in_orgtree=
- =make_indef_if_repeat_then_extend_defmap_in_orgtree=
- =truenode_in_orgtree_is_indefinitive=
- =collect_child_treeids_in_orgtree=
- =get_pid_in_tree= (generic version)

** DONE Chunk 5: Start Refactoring =complete_or_restore_each_node_in_branch=

Created =complete_or_restore_each_node_in_branch_v2= in =server/to_org/complete/contents.rs=:
- Initially delegated to old version via temporary conversions
- Established pattern for incremental refactoring

** DONE Chunk 6: Refactor v2 Internals

Updated =complete_or_restore_each_node_in_branch_v2= to work directly with tree+map:
- Uses =add_v_to_map_if_absent= instead of =ensure_skgnode=
- Uses all =_in_orgtree= helper functions
- No more internal PairTree usage

** DONE Chunk 7: Additional Helpers

Created in =server/types/tree/orgnode_skgnode.rs=:
- =unique_orgnode_scaffold_child= - find scaffold child in Tree<OrgNode>
- =insert_scaffold_as_child_in_orgtree= - add scaffold nodes
- =append_indefinitive_from_disk_as_child_in_orgtree= - fetch and add nodes

** DONE Chunk 8: Refactor =completeAliasCol=

Created =completeAliasCol_v2= in =server/to_org/complete/aliascol.rs=:
- Works entirely with Tree<OrgNode> + SkgNodeMap
- Uses helper functions from Chunk 7

** DONE Chunk 9: Refactor =maybe_add_subscribeeCol_branch=

Created in =server/to_org/complete/sharing.rs=:
- =maybe_add_subscribeeCol_branch_v2= - works with tree+map
- Supporting helpers in =server/types/tree/orgnode_skgnode.rs=:
  - =pids_for_subscriber_and_its_subscribees_in_orgtree=
  - Uses =append_indefinitive_from_disk_as_child_in_orgtree=

Updated =complete_or_restore_each_node_in_branch_v2=:
- Eliminated LAST PairTree conversion
- Now works entirely with Tree<OrgNode> + SkgNodeMap

** DONE Chunk 10: Refactor String Rendering

Created =orgnode_forest_to_string_v2= in =server/org_to_text.rs=:
- Takes Tree<OrgNode> instead of PairTree
- Only needs OrgNode data for rendering

** DONE Chunk 11: Refactor Metadata Viewdata

Created in =server/viewdata.rs=:
- =set_metadata_relationship_viewdata_in_forest_v2=
- =mapsFromIdForView_from_orgtree=
- =set_metadata_relationships_in_node_recursive_v2=

Created =collect_ids_from_orgtree= in =server/to_org/util.rs=.

** DONE Chunk 12: Refactor View Request Execution

Created in =server/to_org/util.rs=:
- =content_ids_if_definitive_else_empty_in_orgtree=
- =complete_branch_minus_content_in_orgtree=
- =build_node_branch_minus_content_v2=

Created in =server/to_org/complete/contents.rs=:
- =ensure_source_v2=

Created in =server/to_org/complete/sharing.rs=:
- =type_and_parent_type_consistent_with_subscribee_in_orgtree=
- =maybe_add_hiddenInSubscribeeCol_branch_v2=

Created in =server/types/tree/orgnode_skgnode.rs=:
- =pid_for_subscribee_and_its_subscriber_grandparent_in_orgtree=

Created in =server/to_org/expand/definitive.rs=:
- =get_hidden_ids_if_subscribee_v2=
- =indefinitize_content_subtree_v2=
- =extendDefinitiveSubtreeFromLeaf_v2=
- =from_disk_replace_title_body_and_skgnode_v2=
- =execute_definitive_view_request_v2=
- =execute_view_requests_v2= (uses temporary conversions for Aliases/Containerward/Sourceward)

** DONE Chunk 13: Refactor Entry Point

Created =update_from_and_rerender_buffer_v2= in =server/serve/handlers/save_buffer.rs=:
- Uses =skgnode_map_from_save_instructions= to build map
- Keeps forest as =Tree<OrgNode>= (no pairing step)
- Calls v2 versions of all functions
- No PairTree usage throughout

Made =collectViewRequestsFromForest= generic in =server/to_org/expand/collect_view_requests.rs=:
- Works with both =PairTree= and =Tree<OrgNode>=
- Added =AsRef<OrgNode>= trait implementations for =NodePair= and =OrgNode=

** DONE Chunk 14: Switch Entry Point to v2

In =server/serve/handlers/save_buffer.rs=:
- Changed =handle_save_buffer_request= to call =update_from_and_rerender_buffer_v2=
- All 33 tests pass
- Production code now uses Tree<OrgNode> + SkgNodeMap throughout

* Remaining Work

** Convert tests.
   Every test for a function that has a new version
   should be converted to use the new version,
   in a way that minimizes the resulting diff.
** Other Modules to Refactor (Optional)

- =server/to_org/expand/aliases.rs= - create v2 for aliases view requests
- =server/to_org/expand/backpath.rs= - create v2 for containerward/sourceward
- =server/to_org/render/initial_bfs.rs= - initial forest rendering

** Cleanup

Once all callers use v2 versions:
- Remove old PairTree functions
- Rename v2 functions (drop suffix)
- Remove PairTree type alias if unused
