=== Definitive View Request: Implementation Status ===

Request that an indefinitive OrgNode expand its content from disk, becoming definitive.

* Status Summary

** DONE Core Implementation
- [X] ~ViewRequest::Definitive~ variant in ~types/orgnode.rs~ (with FromStr/Display)
- [X] Validation errors in ~types/errors.rs~
- [X] Validation in ~read_buffer/buffer_to_orgnodes/validate_tree.rs~
- [X] ~VisitedMap~ type alias (~HashMap<ID, (usize, NodeId)>~) in ~to_org/util.rs~
- [X] Two-phase processing in ~to_org/complete_contents.rs~
- [X] ~indefinitize_content_subtree~ in ~to_org/definitive_branch.rs~
- [X] ~extendDefinitiveSubtreeFromLeaf~ with BFS expansion in ~to_org/definitive_branch.rs~
- [X] ~execute_definitive_view_request~ (the main entry point) in ~to_org/definitive_branch.rs~
- [X] Generation calculations use effective root (not true tree root) to avoid clobbering nodes outside the expanded subtree

** DONE Emacs Support
- [X] ~skg-request-definitive-view~ in ~elisp/skg-request-views.el~
- [X] Display support in ~elisp/heralds-minor-mode.el~

** TODO Remaining Work
- [ ] Dedicated tests for definitive view requests
- [ ] Integration test exercising the full flow

* Key Design Decisions

** Two-Phase Processing

Phase 1 (~completeOrgnodeForest_collectingDefinitiveRequests~): Process the tree normally,
skipping ~ViewRequest::Definitive~. Collect requests for later. Build ~visited~ map.

Phase 2 (~execute_definitive_view_requests~): Process collected requests sequentially.
Each request gets a fresh node budget. Sequential processing ensures ~visited~ accumulates correctly.

** Effective Root for Generation Calculations

When expanding a definitive subtree, generation numbers are relative to the node
containing the request (the "effective root"), not the true tree root. This ensures
that truncation only affects nodes within the expanded subtree, not siblings of ancestors
elsewhere in the tree.

** Fresh Budget Per Request

Each definitive view request gets the full ~initial_node_limit~ budget. This is intentional:
the user explicitly requested multiple expansions.

* Validation Rules

1. Node must be indefinitive (error: ~DefinitiveRequestOnDefinitiveNode~)
2. Node must be childless (error: ~DefinitiveRequestOnNodeWithChildren~)
3. At most one request per ID (error: ~MultipleDefinitiveRequestsForSameId~)

* Algorithm Overview

For each definitive view request:

1. If another OrgNode is currently definitive for this ID:
   - Call ~indefinitize_content_subtree~ on that node
   - This removes it and its content descendants from ~visited~

2. Mark this node definitive, add to ~visited~

3. Expand content via ~extendDefinitiveSubtreeFromLeaf~:
   - BFS from the requesting node
   - Mark repeats (in ~visited~) and cycles as indefinitive
   - Add new definitive nodes to ~visited~
   - Truncate when node limit exceeded (marking last generation indefinitive)

4. Clear the ~ViewRequest::Definitive~ from the node

* Files

- ~rust/to_org/definitive_branch.rs~ - Main implementation
- ~rust/to_org/complete_contents.rs~ - Two-phase orchestration
- ~rust/to_org/util.rs~ - ~VisitedMap~ type alias and helpers
- ~rust/media/tree.rs~ - ~collect_generation_ids~ (with effective root support)
- ~rust/types/orgnode.rs~ - ~ViewRequest::Definitive~ variant
- ~rust/types/errors.rs~ - Validation error variants
- ~rust/read_buffer/buffer_to_orgnodes/validate_tree.rs~ - Request validation
- ~elisp/skg-request-views.el~ - Emacs command
- ~elisp/heralds-minor-mode.el~ - Display
